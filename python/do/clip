#!/usr/bin/env python3
# Capture random bits

import sys
import os
import re

from pyutil import git_update
from pyutil import git_commit
from pyutil import ensure_file
from pyutil import insert_into
from pyutil import get_datetime

template_header = '''\
# {month}

'''

template_entry = '''\
{link} {date_time}

---

'''


def new_clip(link):
    re_link = '\[.*\]\(.*\)'
    if re.search(re_link, link):
        date_time = get_datetime()
        entry = template_entry.format(link=link, date_time=date_time)
        # echo back
        print('Link')
        print(entry)
        # update
        clip_dir = os.path.dirname(os.environ['DOTFILES']) + '/clips'
        git_update(clip_dir)
        # new file for new month
        month = get_datetime('%Y-%m')
        filename = os.path.join(clip_dir, month) + '.md'
        header = template_header.format(month=month)
        ensure_file(filename, header)
        # insert entry
        insert_into(filename, 2, entry)
        # commit
        git_commit(clip_dir, [filename], 'clip')
    else:
        print('Undefined')


if __name__ == '__main__':
    if len(sys.argv) != 2:
        print("Usage: clip '[title](url)'")
        sys.exit()

    new_clip(sys.argv[1])
